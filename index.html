<script>
    // Prendi createClient dal bundle CDN v2
    const { createClient } = window.supabase;

    // Configurazione Supabase
    let supabase = null;
    let currentConfig = {};

    document.addEventListener('DOMContentLoaded', function() {
        loadConfig();
        if (currentConfig.supabaseUrl && currentConfig.supabaseKey) {
            initSupabase();
            loadAllData();
        }
    });

    function loadConfig() {
        const saved = localStorage.getItem('supabaseConfig');
        if (saved) {
            currentConfig = JSON.parse(saved);
        } else {
            currentConfig = {};
        }
        document.getElementById('supabaseUrl').value = currentConfig.supabaseUrl || '';
        document.getElementById('supabaseKey').value = currentConfig.supabaseKey || '';
    }

    function saveConfig() {
        currentConfig.supabaseUrl = document.getElementById('supabaseUrl').value.trim();
        currentConfig.supabaseKey = document.getElementById('supabaseKey').value.trim();
        localStorage.setItem('supabaseConfig', JSON.stringify(currentConfig));

        if (currentConfig.supabaseUrl && currentConfig.supabaseKey) {
            initSupabase();
            loadAllData();
            showAlert('‚úÖ Configurazione salvata e connessione stabilita!', 'success');
        } else {
            showAlert('‚ùå Inserisci URL e Key Supabase', 'error');
        }
    }

    async function testConnection() {
        const url = document.getElementById('supabaseUrl').value.trim();
        const key = document.getElementById('supabaseKey').value.trim();
        if (!url || !key) {
            showAlert('‚ùå Inserisci URL e Key Supabase', 'error');
            return;
        }
        try {
            const testClient = createClient(url, key);
            const { data, error } = await testClient
                .from('licenses')
                .select('*')
                .limit(1);

            if (error) throw error;
            showAlert('‚úÖ Connessione riuscita! Database accessibile.', 'success');
        } catch (err) {
            showAlert(`‚ùå Errore di connessione: ${err.message}`, 'error');
        }
    }

    function initSupabase() {
        if (!currentConfig.supabaseUrl || !currentConfig.supabaseKey) {
            showAlert('‚ùå Configura prima Supabase', 'error');
            return;
        }
        try {
            supabase = createClient(currentConfig.supabaseUrl, currentConfig.supabaseKey);
            console.log('Supabase inizializzato');
        } catch (err) {
            showAlert(`‚ùå Errore inizializzazione Supabase: ${err.message}`, 'error');
        }
    }

    // Tabs: passiamo esplicitamente il bottone
    function showTab(tabName, btnEl) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        if (btnEl) btnEl.classList.add('active');
    }

    async function loadAllData() {
        if (!supabase) return;
        await Promise.all([loadLicenses(), loadActivations(), loadLogs()]);
    }

    async function loadLicenses() {
        try {
            const { data, error } = await supabase
                .from('licenses')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) throw error;
            displayLicenses(data || []);
        } catch (err) {
            showAlert(`‚ùå Errore caricamento licenze: ${err.message}`, 'error');
        }
    }

    function displayLicenses(licenses) {
        const content = document.getElementById('licensesContent');
        if (!licenses.length) {
            content.innerHTML = '<p>Nessuna licenza trovata.</p>';
            return;
        }
        let html = `
            <table class="table">
                <thead>
                    <tr>
                        <th>Chiave Licenza</th>
                        <th>Utente</th>
                        <th>Email</th>
                        <th>Stato</th>
                        <th>Attivazioni</th>
                        <th>Scadenza</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
        `;
        licenses.forEach(license => {
            const statusClass = license.is_active ? 'status-active' : 'status-inactive';
            const statusText = license.is_active ? '‚úÖ Attiva' : '‚ùå Inattiva';
            html += `
                <tr>
                    <td><strong>${license.license_key}</strong></td>
                    <td>${license.user_name || 'N/A'}</td>
                    <td>${license.user_email || 'N/A'}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>${license.activations_count || 0}/${license.max_activations ?? '-'}</td>
                    <td>${license.expires_at || 'Nessuna scadenza'}</td>
                    <td>
                        ${license.is_active
                            ? `<a href="#" onclick="deactivateLicense('${license.license_key}')" class="btn btn-danger">‚ùå Disattiva</a>`
                            : `<a href="#" onclick="activateLicense('${license.license_key}')" class="btn btn-success">‚úÖ Attiva</a>`
                        }
                        <a href="#" onclick="editLicense('${license.license_key}', '${license.user_email || ''}', '${license.user_name || ''}', ${license.max_activations ?? 1})" class="btn">‚úèÔ∏è Modifica</a>
                        <a href="#" onclick="deleteLicense('${license.license_key}')" class="btn btn-danger">üóëÔ∏è Elimina</a>
                    </td>
                </tr>
            `;
        });
        html += '</tbody></table>';
        content.innerHTML = html;
    }

    async function loadActivations() {
        try {
            const { data, error } = await supabase
                .from('activations')
                .select('*')
                .order('activated_at', { ascending: false });

            if (error) throw error;
            displayActivations(data || []);
        } catch (err) {
            showAlert(`‚ùå Errore caricamento attivazioni: ${err.message}`, 'error');
        }
    }

    function displayActivations(activations) {
        const content = document.getElementById('activationsContent');
        if (!activations.length) {
            content.innerHTML = '<p>Nessuna attivazione trovata.</p>';
            return;
        }
        let html = `
            <table class="table">
                <thead>
                    <tr>
                        <th>Licenza</th>
                        <th>Hardware ID</th>
                        <th>Piattaforma</th>
                        <th>Versione</th>
                        <th>Data Attivazione</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
        `;
        activations.forEach(a => {
            html += `
                <tr>
                    <td><strong>${a.license_key}</strong></td>
                    <td><code>${a.hardware_id}</code></td>
                    <td>${a.platform}</td>
                    <td>${a.version}</td>
                    <td>${a.activated_at}</td>
                    <td><a href="#" onclick="deleteActivation(${a.id})" class="btn btn-danger">üóëÔ∏è Elimina</a></td>
                </tr>
            `;
        });
        html += '</tbody></table>';
        content.innerHTML = html;
    }

    async function loadLogs() {
        try {
            const { data, error } = await supabase
                .from('logs')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(100);

            if (error) throw error;
            displayLogs(data || []);
        } catch (err) {
            showAlert(`‚ùå Errore caricamento log: ${err.message}`, 'error');
        }
    }

    function displayLogs(logs) {
        const content = document.getElementById('logsContent');
        if (!logs.length) {
            content.innerHTML = '<p>Nessun log trovato.</p>';
            return;
        }
        let html = `
            <table class="table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Licenza</th>
                        <th>Azione</th>
                        <th>Dettagli</th>
                    </tr>
                </thead>
                <tbody>
        `;
        logs.forEach(l => {
            html += `
                <tr>
                    <td>${l.created_at}</td>
                    <td><strong>${l.license_key}</strong></td>
                    <td>${l.action}</td>
                    <td>${l.details || ''}</td>
                </tr>
            `;
        });
        html += '</tbody></table>';
        content.innerHTML = html;
    }

    async function activateLicense(licenseKey) {
        try {
            const { error } = await supabase
                .from('licenses')
                .update({ is_active: true })
                .eq('license_key', licenseKey);
            if (error) throw error;
            showAlert('‚úÖ Licenza attivata con successo!', 'success');
            loadLicenses();
        } catch (err) {
            showAlert(`‚ùå Errore nell'attivazione: ${err.message}`, 'error');
        }
    }

    async function deactivateLicense(licenseKey) {
        try {
            const { error } = await supabase
                .from('licenses')
                .update({ is_active: false })
                .eq('license_key', licenseKey);
            if (error) throw error;
            showAlert('‚ùå Licenza disattivata con successo!', 'success');
            loadLicenses();
        } catch (err) {
            showAlert(`‚ùå Errore nella disattivazione: ${err.message}`, 'error');
        }
    }

    async function deleteLicense(licenseKey) {
        if (!confirm('‚ö†Ô∏è Sei sicuro di voler eliminare questa licenza? Questa azione non pu√≤ essere annullata!')) return;
        try {
            await supabase.from('activations').delete().eq('license_key', licenseKey);
            const { error } = await supabase.from('licenses').delete().eq('license_key', licenseKey);
            if (error) throw error;
            showAlert('üóëÔ∏è Licenza eliminata con successo!', 'success');
            loadAllData();
        } catch (err) {
            showAlert(`‚ùå Errore nell'eliminazione: ${err.message}`, 'error');
        }
    }

    async function deleteActivation(activationId) {
        if (!confirm('‚ö†Ô∏è Eliminare questa attivazione? L\'utente dovr√† riattivare la licenza.')) return;
        try {
            const { error } = await supabase.from('activations').delete().eq('id', activationId);
            if (error) throw error;
            showAlert('üóëÔ∏è Attivazione eliminata con successo!', 'success');
            loadActivations();
        } catch (err) {
            showAlert(`‚ùå Errore nell\'eliminazione: ${err.message}`, 'error');
        }
    }

    function editLicense(licenseKey, userEmail, userName, maxActivations) {
        document.getElementById('editLicenseKey').value = licenseKey;
        document.getElementById('editUserEmail').value = userEmail;
        document.getElementById('editUserName').value = userName;
        document.getElementById('editMaxActivations').value = maxActivations || 1;
        document.getElementById('editModal').style.display = 'block';
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    async function saveLicenseEdit(event) {
        event.preventDefault();
        const licenseKey = document.getElementById('editLicenseKey').value;
        const userEmail = document.getElementById('editUserEmail').value || null;
        const userName = document.getElementById('editUserName').value || null;
        const maxActivations = parseInt(document.getElementById('editMaxActivations').value || '1', 10);
        const expiresAt = document.getElementById('editExpiresAt').value;

        const updateData = {
            user_email: userEmail,
            user_name: userName,
            max_activations: maxActivations,
            updated_at: new Date().toISOString(),
            expires_at: expiresAt ? new Date(expiresAt).toISOString() : null,
        };

        try {
            const { error } = await supabase
                .from('licenses')
                .update(updateData)
                .eq('license_key', licenseKey);
            if (error) throw error;
            showAlert('‚úÖ Licenza aggiornata con successo!', 'success');
            closeEditModal();
            loadLicenses();
        } catch (err) {
            showAlert(`‚ùå Errore nell\'aggiornamento: ${err.message}`, 'error');
        }
    }

    async function createLicense(event) {
        event.preventDefault();
        const formData = new FormData(event.target);

        let features = ['all'];
        const rawFeatures = formData.get('features');
        if (rawFeatures) {
            try { features = JSON.parse(rawFeatures); }
            catch { return showAlert('‚ùå "Funzionalit√†" deve essere JSON valido (es: ["all"])', 'error'); }
        }

        const payload = {
            user_email: formData.get('user_email'),
            user_name: formData.get('user_name'),
            max_activations: parseInt(formData.get('max_activations') || '1', 10),
            features,
            is_active: true,
            activations_count: 0,
            created_at: new Date().toISOString()
        };

        try {
            const { error } = await supabase.from('licenses').insert(payload);
            if (error) throw error;
            showAlert('üöÄ Licenza creata con successo!', 'success');
            event.target.reset();
            loadLicenses();
        } catch (err) {
            showAlert(`‚ùå Errore nella creazione: ${err.message}`, 'error');
        }
    }

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;
        document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.tabs'));
        setTimeout(() => alertDiv.remove(), 5000);
    }

    document.getElementById('editForm').addEventListener('submit', saveLicenseEdit);
    document.getElementById('createLicenseForm').addEventListener('submit', createLicense);

    document.getElementById('editModal').addEventListener('click', function(e) {
        if (e.target === this) closeEditModal();
    });
</script>
